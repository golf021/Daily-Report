<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>แบบบันทึกหน้างาน (มือถือ)</title>
  <meta name="description" content="ฟอร์มบันทึกหน้างานสำหรับมือถือ — ชื่อลูกค้า, ที่อยู่, โลเคชัน, ไมล์รถ, รูปภาพ" />
  <style>
    :root{--bg:#f7f8fb;--card:#ffffff;--accent:#0b76ef;--muted:#666;--error:#e53935}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans',"Helvetica Neue",Arial;background:var(--bg);margin:0;padding:16px;color:#111}
    .container{max-width:760px;margin:0 auto}
    h1{font-size:18px;margin:0 0 12px}
    .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 2px 8px rgba(16,24,40,0.06);margin-bottom:12px}
    label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
    input[type=text], input[type=number], textarea, select{width:100%;padding:10px;border:1px solid #e6e9ef;border-radius:8px;font-size:14px}
    input.error{border-color:var(--error)}
    .error-text{color:var(--error);font-size:12px;margin-top:4px;display:none}
    .row{display:flex;gap:8px}
    .row > *{flex:1}
    .btn{display:inline-block;padding:10px 12px;border-radius:10px;border:0;background:var(--accent);color:#fff;font-weight:600;cursor:pointer;transition:opacity 0.2s}
    .btn:disabled{opacity:0.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(11,118,239,0.12)}
    .small{font-size:13px;padding:8px 10px}
    .photos-preview{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .photos-preview img{width:84px;height:84px;object-fit:cover;border-radius:8px;border:1px solid #eee}
    .saved-list{list-style:none;padding:0;margin:0}
    .saved-item{padding:10px;border-bottom:1px solid #f1f3f6}
    .meta{font-size:12px;color:var(--muted)}
    footer{font-size:12px;color:var(--muted);text-align:center;margin-top:18px}
    .loading{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:#fff;animation:spin 1s linear infinite;margin-right:8px;vertical-align:middle}
    @keyframes spin{to{transform:rotate(360deg)}}
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);color:white;padding:12px 16px;border-radius:8px;z-index:1000;opacity:0;transition:opacity 0.3s}
    .toast.show{opacity:1}
    .storage-info{font-size:12px;color:var(--muted);margin-top:8px;text-align:right}
    @media (max-width:420px){body{padding:10px} .row{flex-direction:column}}
  </style>
</head>
<body>
  <div class="container">
    <h1>ฟอร์มบันทึกหน้างาน (มือถือ)</h1>

    <div class="card">
      <label for="customer">ชื่อลูกค้า <span style="color:var(--error)">*</span></label>
      <input id="customer" type="text" placeholder="เช่น นายสมชาย" required />
      <div class="error-text" id="customer-error">กรุณากรอกชื่อลูกค้า</div>

      <div style="height:8px"></div>

      <label>ที่อยู่ (ตำบล, อำเภอ, จังหวัด)</label>
      <div class="row">
        <input id="tambon" type="text" placeholder="ตำบล" />
        <input id="amphoe" type="text" placeholder="อำเภอ" />
        <input id="province" type="text" placeholder="จังหวัด" />
      </div>

      <div style="height:8px"></div>

      <label for="location">โลเคชัน (ละติจูด, ลองจิจูด)</label>
      <div class="row">
        <input id="lat" type="text" placeholder="ละติจูด" />
        <input id="lng" type="text" placeholder="ลองจิจูด" />
      </div>
      <div style="height:6px"></div>
      <button id="getLocation" class="btn small">
        <span id="location-loader" class="loading" style="display:none"></span>
        รับตำแหน่งปัจจุบัน
      </button>

      <div style="height:8px"></div>

      <label for="mileage">ไมล์รถ (กม. / ไมล์)</label>
      <input id="mileage" type="number" placeholder="เช่น 12345" min="0" />

      <div style="height:8px"></div>

      <label for="photos">รูปหน้างาน (แนบได้หลายรูป, สูงสุด 50 รูป)</label>
      <input id="photos" type="file" accept="image/*" multiple />
      <div class="error-text" id="photos-error">สามารถอัปโหลดได้สูงสุด 50 รูป</div>
      <div class="photos-preview" id="preview"></div>
      <div class="storage-info" id="storage-info">กำลังใช้พื้นที่: 0MB</div>

      <div style="height:10px"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="save" class="btn">บันทึก</button>
        <button id="resetForm" class="btn ghost small">ล้างฟอร์ม</button>
        <button id="exportJson" class="btn ghost small">Export JSON</button>
      </div>
    </div>

    <div class="card">
      <h2 style="font-size:15px;margin:0 0 8px">รายการที่บันทึก</h2>
      <ul id="saved" class="saved-list"></ul>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px">
        <button id="downloadAll" class="btn small">ดาวน์โหลดทั้งหมด (JSON)</button>
        <button id="clearAll" class="btn ghost small">ลบทั้งหมด</button>
      </div>
    </div>

    <footer>เก็บข้อมูลลงเครื่อง (IndexedDB) — สามารถดาวน์โหลดไฟล์ JSON เพื่อนำไปใช้ต่อ</footer>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // Helpers
    const by = id => document.getElementById(id);
    const preview = by('preview');
    const photosInput = by('photos');
    const MAX_PHOTOS = 50;
    const DB_NAME = 'SiteLogsDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'siteLogs';

    let db = null;
    let currentFilesBase64 = [];

    // ฟังก์ชันแสดงข้อความแจ้งเตือน
    function showToast(message, duration = 3000) {
      const toast = by('toast');
      toast.textContent = message;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, duration);
    }

    // เปิดการเชื่อมต่อกับ IndexedDB
    function openDatabase() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);
        
        request.onupgradeneeded = (event) => {
          const database = event.target.result;
          if (!database.objectStoreNames.contains(STORE_NAME)) {
            const store = database.createObjectStore(STORE_NAME, { 
              keyPath: 'id', 
              autoIncrement: true 
            });
            store.createIndex('createdAt', 'createdAt', { unique: false });
          }
        };
      });
    }

    // บันทึกข้อมูล
    async function saveEntry(entry) {
      if (!db) db = await openDatabase();
      
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.add(entry);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);
      });
    }

    // โหลดข้อมูลทั้งหมด
    async function loadAllEntries() {
      if (!db) db = await openDatabase();
      
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const index = store.index('createdAt');
        const request = index.getAll();
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);
      });
    }

    // ลบข้อมูลทั้งหมด
    async function clearAllEntries() {
      if (!db) db = await openDatabase();
      
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.clear();
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve();
      });
    }

    // ลบรายการเดียว
    async function deleteEntry(id) {
      if (!db) db = await openDatabase();
      
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.delete(id);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve();
      });
    }

    // คำนวณพื้นที่ที่ใช้
    function calculateStorageUsage(entries) {
      const jsonString = JSON.stringify(entries);
      const bytes = new Blob([jsonString]).size;
      const megabytes = bytes / (1024 * 1024);
      return megabytes.toFixed(2);
    }

    photosInput.addEventListener('change', async e => {
      const files = Array.from(e.target.files || []);
      
      // ตรวจสอบจำนวนรูปภาพ
      if (files.length > MAX_PHOTOS) {
        by('photos-error').style.display = 'block';
        photosInput.value = '';
        return;
      } else {
        by('photos-error').style.display = 'none';
      }
      
      preview.innerHTML = '';
      currentFilesBase64 = [];
      
      for (const f of files) {
        if (!f.type.startsWith('image/')) continue;
        
        // บีบอัดภาพก่อนแปลงเป็น Base64
        const b64 = await compressImage(f);
        currentFilesBase64.push(b64);
        const img = document.createElement('img');
        img.src = b64;
        preview.appendChild(img);
      }
    });

    // บีบอัดภาพ
    function compressImage(file, maxWidth = 1024, quality = 0.7) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            resolve(canvas.toDataURL('image/jpeg', quality));
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Geolocation
    by('getLocation').addEventListener('click', ()=>{
      if (!navigator.geolocation) {
        showToast('เบราว์เซอร์ไม่รองรับ Geolocation');
        return;
      }
      
      const loader = by('location-loader');
      loader.style.display = 'inline-block';
      by('getLocation').disabled = true;
      
      navigator.geolocation.getCurrentPosition(pos =>{
        loader.style.display = 'none';
        by('getLocation').disabled = false;
        by('lat').value = pos.coords.latitude.toFixed(6);
        by('lng').value = pos.coords.longitude.toFixed(6);
        showToast('รับตำแหน่งสำเร็จ');
      }, err => {
        loader.style.display = 'none';
        by('getLocation').disabled = false;
        showToast('ไม่สามารถรับตำแหน่งได้: ' + err.message);
      }, {enableHighAccuracy:true, timeout:10000});
    });

    async function renderSaved(){
      const list = await loadAllEntries();
      const ul = by('saved'); 
      ul.innerHTML = '';
      
      if (!list.length) { 
        ul.innerHTML = '<li class="meta">ยังไม่มีรายการที่บันทึก</li>'; 
        by('storage-info').textContent = 'กำลังใช้พื้นที่: 0MB';
        return; 
      }
      
      // อัปเดตข้อมูลพื้นที่ที่ใช้
      const storageUsage = calculateStorageUsage(list);
      by('storage-info').textContent = `กำลังใช้พื้นที่: ${storageUsage}MB`;
      
      // แสดงเพียง 10 รายการล่าสุด
      const displayList = list.slice().reverse().slice(0, 10);
      
      displayList.forEach((item, idx)=>{
        const li = document.createElement('li'); 
        li.className='saved-item card';
        const d = new Date(item.createdAt);
        li.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:600">${escapeHtml(item.customer||'-')}</div>
              <div class="meta">${escapeHtml(item.tambon||'')} ${escapeHtml(item.amphoe||'')} ${escapeHtml(item.province||'')}</div>
            </div>
            <div style="text-align:right;font-size:12px;color:var(--muted)">${d.toLocaleString()}</div>
          </div>
          <div style="height:8px"></div>
          <div class="meta">โลเคชัน: ${item.lat||'-'}, ${item.lng||'-'} • ไมล์: ${item.mileage||'-'}</div>
        `;
        
        // thumbnails
        if (item.photos && item.photos.length){
          const wrap = document.createElement('div'); 
          wrap.className='photos-preview';
          item.photos.slice(0,6).forEach(p=>{ 
            const i=document.createElement('img'); 
            i.src=p; 
            wrap.appendChild(i); 
          });
          li.appendChild(wrap);
        }
        
        // actions
        const actions = document.createElement('div'); 
        actions.style.marginTop='8px';
        
        const btnExport = document.createElement('button'); 
        btnExport.className='btn small ghost'; 
        btnExport.textContent='Export';
        btnExport.addEventListener('click', ()=> downloadObject(item, `entry-${d.getTime()}.json`));
        
        const btnDelete = document.createElement('button'); 
        btnDelete.className='btn small ghost'; 
        btnDelete.textContent='ลบรายการ';
        btnDelete.addEventListener('click', async ()=>{
          if (!confirm('ลบรายการนี้หรือไม่?')) return;
          try {
            await deleteEntry(item.id);
            renderSaved();
            showToast('ลบรายการสำเร็จ');
          } catch (error) {
            showToast('เกิดข้อผิดพลาดในการลบรายการ');
            console.error(error);
          }
        });
        
        actions.appendChild(btnExport); 
        actions.appendChild(btnDelete);
        li.appendChild(actions);
        ul.appendChild(li);
      });
      
      // แสดงข้อความหากมีรายการมากกว่า 10
      if (list.length > 10) {
        const moreLi = document.createElement('li');
        moreLi.className = 'meta';
        moreLi.textContent = `แสดง 10 รายการล่าสุดจากทั้งหมด ${list.length} รายการ`;
        ul.appendChild(moreLi);
      }
    }

    function escapeHtml(str){ 
      return String(str||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); 
    }

    // ฟังก์ชันตรวจสอบความถูกต้องของฟอร์ม
    function validateForm() {
      let isValid = true;
      
      // ตรวจสอบชื่อลูกค้า
      if (!by('customer').value.trim()) {
        by('customer').classList.add('error');
        by('customer-error').style.display = 'block';
        isValid = false;
      } else {
        by('customer').classList.remove('error');
        by('customer-error').style.display = 'none';
      }
      
      return isValid;
    }

    // Save entry
    by('save').addEventListener('click', async ()=>{
      if (!validateForm()) {
        showToast('กรุณากรอกข้อมูลให้ครบถ้วน');
        return;
      }
      
      const entry = {
        customer: by('customer').value.trim(),
        tambon: by('tambon').value.trim(),
        amphoe: by('amphoe').value.trim(),
        province: by('province').value.trim(),
        lat: by('lat').value.trim(),
        lng: by('lng').value.trim(),
        mileage: by('mileage').value.trim(),
        photos: currentFilesBase64.slice(),
        createdAt: new Date().toISOString()
      };
      
      try {
        await saveEntry(entry);
        renderSaved();
        showToast('บันทึกสำเร็จ');
        clearForm();
      } catch (error) {
        showToast('เกิดข้อผิดพลาดในการบันทึก');
        console.error(error);
      }
    });

    by('resetForm').addEventListener('click', ()=>{ 
      if(confirm('ล้างฟอร์มหรือไม่?')) {
        clearForm(); 
        showToast('ล้างฟอร์มแล้ว');
      }
    });

    function clearForm(){ 
      by('customer').value=''; 
      by('tambon').value=''; 
      by('amphoe').value=''; 
      by('province').value=''; 
      by('lat').value=''; 
      by('lng').value=''; 
      by('mileage').value=''; 
      photosInput.value=''; 
      preview.innerHTML=''; 
      currentFilesBase64 = []; 
      
      // ล้างสถานะ error
      by('customer').classList.remove('error');
      by('customer-error').style.display = 'none';
      by('photos-error').style.display = 'none';
    }

    // Export & download helpers
    function downloadObject(obj, filename){ 
      const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'}); 
      const url=URL.createObjectURL(blob); 
      const a=document.createElement('a'); 
      a.href=url; 
      a.download=filename; 
      a.click(); 
      URL.revokeObjectURL(url); 
    }

    by('downloadAll').addEventListener('click', async ()=>{
      try {
        const arr = await loadAllEntries();
        if(!arr.length){ 
          showToast('ไม่มีข้อมูลที่จะดาวน์โหลด'); 
          return; 
        }
        downloadObject(arr, `site-logs-${new Date().toISOString().slice(0,10)}.json`);
        showToast('ดาวน์โหลดข้อมูลสำเร็จ');
      } catch (error) {
        showToast('เกิดข้อผิดพลาดในการดาวน์โหลด');
        console.error(error);
      }
    });

    by('clearAll').addEventListener('click', async ()=>{
      if(!confirm('ลบข้อมูลทั้งหมดออกจากเครื่องหรือไม่?')) return; 
      try {
        await clearAllEntries();
        renderSaved();
        showToast('ลบข้อมูลทั้งหมดแล้ว');
      } catch (error) {
        showToast('เกิดข้อผิดพลาดในการลบข้อมูล');
        console.error(error);
      }
    });

    by('exportJson').addEventListener('click', async ()=>{
      try {
        const arr = await loadAllEntries();
        downloadObject(arr, `site-logs-${new Date().toISOString().slice(0,10)}.json`);
        showToast('ส่งออกข้อมูลสำเร็จ');
      } catch (error) {
        showToast('เกิดข้อผิดพลาดในการส่งออกข้อมูล');
        console.error(error);
      }
    });

    // เริ่มต้นแอปพลิเคชัน
    async function initApp() {
      try {
        db = await openDatabase();
        renderSaved();
      } catch (error) {
        showToast('เกิดข้อผิดพลาดในการโหลดข้อมูล');
        console.error(error);
      }
    }

    // initial render
    initApp();
  </script>
</body>
</html>
