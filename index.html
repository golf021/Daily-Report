<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡πÅ‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)</title>
  <meta name="description" content="‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ‚Äî ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤, ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà, ‡πÇ‡∏•‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô, ‡πÑ‡∏°‡∏•‡πå‡∏£‡∏ñ, ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û" />
  <style>
    :root{--bg:#f7f8fb;--card:#ffffff;--accent:#0b76ef;--muted:#666;--error:#e53935;--success:#43a047}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans',"Helvetica Neue",Arial;background:var(--bg);margin:0;padding:16px;color:#111}
    .container{max-width:760px;margin:0 auto}
    h1{font-size:18px;margin:0 0 12px}
    .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 2px 8px rgba(16,24,40,0.06);margin-bottom:12px}
    label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
    input[type=text], input[type=number], textarea, select{width:100%;padding:10px;border:1px solid #e6e9ef;border-radius:8px;font-size:14px}
    input.error{border-color:var(--error)}
    .error-text{color:var(--error);font-size:12px;margin-top:4px;display:none}
    .row{display:flex;gap:8px}
    .row > *{flex:1}
    .btn{display:inline-block;padding:10px 12px;border-radius:10px;border:0;background:var(--accent);color:#fff;font-weight:600;cursor:pointer;transition:opacity 0.2s}
    .btn:disabled{opacity:0.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(11,118,239,0.12)}
    .btn.success{background:var(--success)}
    .small{font-size:13px;padding:8px 10px}
    .photos-preview{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .photos-preview img{width:84px;height:84px;object-fit:cover;border-radius:8px;border:1px solid #eee;cursor:pointer}
    .saved-list{list-style:none;padding:0;margin:0}
    .saved-item{padding:10px;border-bottom:1px solid #f1f3f6}
    .meta{font-size:12px;color:var(--muted)}
    footer{font-size:12px;color:var(--muted);text-align:center;margin-top:18px}
    .loading{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:#fff;animation:spin 1s linear infinite;margin-right:8px;vertical-align:middle}
    @keyframes spin{to{transform:rotate(360deg)}}
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);color:white;padding:12px 16px;border-radius:8px;z-index:1000;opacity:0;transition:opacity 0.3s}
    .toast.show{opacity:1}
    .storage-info{font-size:12px;color:var(--muted);margin-top:8px;text-align:right}
    .pagination{display:flex;justify-content:center;gap:8px;margin-top:12px}
    .pagination button{min-width:36px}
    .search-box{margin-bottom:12px;position:relative}
    .search-box input{padding-right:36px}
    .search-icon{position:absolute;right:10px;top:50%;transform:translateY(-50%);color:var(--muted)}
    
    /* Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û */
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.9)}
    .modal-content{display:flex;justify-content:center;align-items:center;height:100%}
    .modal-image{max-width:100%;max-height:80vh;object-fit:contain}
    .modal-close{position:absolute;top:15px;right:15px;color:#fff;font-size:30px;font-weight:bold;cursor:pointer;z-index:1001}
    .modal-nav{position:absolute;top:50%;transform:translateY(-50%);color:#fff;font-size:30px;cursor:pointer;z-index:1001;background:rgba(0,0,0,0.5);width:50px;height:50px;border-radius:50%;display:flex;justify-content:center;align-items:center}
    .modal-prev{left:15px}
    .modal-next{right:15px}
    .modal-caption{position:absolute;bottom:20px;left:0;width:100%;text-align:center;color:#fff;font-size:16px}
    
    @media (max-width:420px){body{padding:10px} .row{flex-direction:column}}
  </style>
</head>
<body>
  <div class="container">
    <h1>‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)</h1>

    <div class="card">
      <label for="customer">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ <span style="color:var(--error)">*</span></label>
      <input id="customer" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢" required />
      <div class="error-text" id="customer-error">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>

      <div style="height:8px"></div>

      <label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (‡∏ï‡∏≥‡∏ö‡∏•, ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠, ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î)</label>
      <div class="row">
        <input id="tambon" type="text" placeholder="‡∏ï‡∏≥‡∏ö‡∏•" />
        <input id="amphoe" type="text" placeholder="‡∏≠‡∏≥‡πÄ‡∏†‡∏≠" />
        <input id="province" type="text" placeholder="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" />
      </div>

      <div style="height:8px"></div>

      <label for="location">‡πÇ‡∏•‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô (‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î, ‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î)</label>
      <div class="row">
        <input id="lat" type="text" placeholder="‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î" />
        <input id="lng" type="text" placeholder="‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î" />
      </div>
      <div style="height:6px"></div>
      <button id="getLocation" class="btn small">
        <span id="location-loader" class="loading" style="display:none"></span>
        ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      </button>

      <div style="height:8px"></div>

      <label for="mileage">‡πÑ‡∏°‡∏•‡πå‡∏£‡∏ñ (‡∏Å‡∏°. / ‡πÑ‡∏°‡∏•‡πå)</label>
      <input id="mileage" type="number" placeholder="‡πÄ‡∏ä‡πà‡∏ô 12345" min="0" />

      <div style="height:8px"></div>

      <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° -->
      <label for="note">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ / ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</label>
      <textarea id="note" rows="3" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô..."></textarea>

      <div style="height:8px"></div>

      <label for="photos">‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô (‡πÅ‡∏ô‡∏ö‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ, ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡∏£‡∏π‡∏õ)</label>
      <input id="photos" type="file" accept="image/*" multiple />
      <div class="error-text" id="photos-error">‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡∏£‡∏π‡∏õ</div>
      <div class="photos-preview" id="preview"></div>
      <div class="storage-info" id="storage-info">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: 0MB</div>

      </div>
    </div>

    <div class="card">
      <h2 style="font-size:15px;margin:0 0 8px">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h2>
      
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏≥‡∏ö‡∏•..." />
        <div class="search-icon">üîç</div>
      </div>
      
      <ul id="saved" class="saved-list"></ul>
      
      <div class="pagination" id="pagination">
        <button id="prevPage" class="btn ghost small">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
        <span id="pageInfo" style="padding:8px;font-size:13px">‡∏´‡∏ô‡πâ‡∏≤ 1</span>
        <button id="nextPage" class="btn ghost small">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
      </div>
      
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px">
        <button id="downloadAll" class="btn small">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (JSON)</button>
        <button id="clearAll" class="btn ghost small">‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      </div>
    </div>

    <footer>‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (IndexedDB) ‚Äî ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå JSON ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≠</footer>
  </div>

  <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û -->
  <div id="imageModal" class="modal">
    <span class="modal-close">&times;</span>
    <div class="modal-content">
      <span class="modal-nav modal-prev">&#10094;</span>
      <img class="modal-image" id="modalImage" src="" alt="">
      <span class="modal-nav modal-next">&#10095;</span>
      <div class="modal-caption" id="modalCaption"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // Helpers
    const by = id => document.getElementById(id);
    const preview = by('preview');
    const photosInput = by('photos');
    const MAX_PHOTOS = 10;
    const DB_NAME = 'SiteLogsDB';
    const DB_VERSION = 2;
    const STORE_NAME = 'siteLogs';

    let db = null;
    let currentFilesBase64 = [];
    let currentPage = 1;
    const itemsPerPage = 5;
    let currentSearchTerm = '';
    let allEntries = [];
    
    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Modal ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
    let modal = by('imageModal');
    let modalImg = by('modalImage');
    let modalCaption = by('modalCaption');
    let currentImageIndex = 0;
    let currentModalImages = [];

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    function showToast(message, duration = 3000) {
      const toast = by('toast');
      toast.textContent = message;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, duration);
    }

    // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö IndexedDB
    function openDatabase() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);
        
        request.onupgradeneeded = (event) => {
          const database = event.target.result;
          if (!database.objectStoreNames.contains(STORE_NAME)) {
            const store = database.createObjectStore(STORE_NAME, { 
              keyPath: 'id', 
              autoIncrement: true 
            });
            store.createIndex('createdAt', 'createdAt', { unique: false });
            store.createIndex('customer', 'customer', { unique: false });
            store.createIndex('tambon', 'tambon', { unique: false });
          }
        };
      });
    }

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    async function saveEntry(entry) {
      if (!db) db = await openDatabase();
      
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.add(entry);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);
      });
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    async function loadAllEntries() {
      if (!db) db = await openDatabase();
      
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const index = store.index('createdAt');
        const request = index.getAll();
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);
      });
    }

    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    async function searchEntries(searchTerm) {
      if (!db) db = await openDatabase();
      
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.getAll();
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          const results = request.result.filter(entry => {
            const searchLower = searchTerm.toLowerCase();
            return (
              (entry.customer && entry.customer.toLowerCase().includes(searchLower)) ||
              (entry.tambon && entry.tambon.toLowerCase().includes(searchLower)) ||
              (entry.amphoe && entry.amphoe.toLowerCase().includes(searchLower)) ||
              (entry.province && entry.province.toLowerCase().includes(searchLower)) ||
              (entry.note && entry.note.toLowerCase().includes(searchLower))
            );
          });
          resolve(results);
        };
      });
    }

    // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    async function clearAllEntries() {
      if (!db) db = await openDatabase();
      
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.clear();
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve();
      });
    }

    // ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    async function deleteEntry(id) {
      if (!db) db = await openDatabase();
      
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.delete(id);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve();
      });
    }

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ
    function calculateStorageUsage(entries) {
      const jsonString = JSON.stringify(entries);
      const bytes = new Blob([jsonString]).size;
      const megabytes = bytes / (1024 * 1024);
      return megabytes.toFixed(2);
    }

    photosInput.addEventListener('change', async e => {
      const files = Array.from(e.target.files || []);
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
      if (files.length > MAX_PHOTOS) {
        by('photos-error').style.display = 'block';
        photosInput.value = '';
        return;
      } else {
        by('photos-error').style.display = 'none';
      }
      
      preview.innerHTML = '';
      currentFilesBase64 = [];
      
      for (const f of files) {
        if (!f.type.startsWith('image/')) continue;
        
        // ‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Base64
        const b64 = await compressImage(f);
        currentFilesBase64.push(b64);
        const img = document.createElement('img');
        img.src = b64;
        img.onclick = () => openModal([b64], 0);
        preview.appendChild(img);
      }
    });

    // ‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏†‡∏≤‡∏û
    function compressImage(file, maxWidth = 800, quality = 0.6) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            resolve(canvas.toDataURL('image/jpeg', quality));
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Geolocation
    by('getLocation').addEventListener('click', ()=>{
      if (!navigator.geolocation) {
        showToast('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation');
        return;
      }
      
      const loader = by('location-loader');
      loader.style.display = 'inline-block';
      by('getLocation').disabled = true;
      
      navigator.geolocation.getCurrentPosition(pos =>{
        loader.style.display = 'none';
        by('getLocation').disabled = false;
        by('lat').value = pos.coords.latitude.toFixed(6);
        by('lng').value = pos.coords.longitude.toFixed(6);
        showToast('‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }, err => {
        loader.style.display = 'none';
        by('getLocation').disabled = false;
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ: ' + err.message);
      }, {enableHighAccuracy:true, timeout:10000});
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
    function openModal(images, index) {
      currentModalImages = images;
      currentImageIndex = index;
      modal.style.display = "block";
      modalImg.src = images[index];
      modalCaption.textContent = `‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà ${index + 1} ‡∏à‡∏≤‡∏Å ${images.length}`;
      
      // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 2 ‡∏£‡∏π‡∏õ
      document.querySelector('.modal-prev').style.display = images.length > 1 ? 'flex' : 'none';
      document.querySelector('.modal-next').style.display = images.length > 1 ? 'flex' : 'none';
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô Modal
    function changeImage(n) {
      currentImageIndex += n;
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï
      if (currentImageIndex >= currentModalImages.length) {
        currentImageIndex = 0;
      } else if (currentImageIndex < 0) {
        currentImageIndex = currentModalImages.length - 1;
      }
      
      modalImg.src = currentModalImages[currentImageIndex];
      modalCaption.textContent = `‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà ${currentImageIndex + 1} ‡∏à‡∏≤‡∏Å ${currentModalImages.length}`;
    }

    // ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å outside ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
    modal.addEventListener('click', (e) => {
      if (e.target === modal || e.target.className === 'modal-close') {
        modal.style.display = "none";
      }
    });

    // ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏≥‡∏ó‡∏≤‡∏á
    document.querySelector('.modal-prev').addEventListener('click', (e) => {
      e.stopPropagation();
      changeImage(-1);
    });

    document.querySelector('.modal-next').addEventListener('click', (e) => {
      e.stopPropagation();
      changeImage(1);
    });

    // ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° keyboard
    document.addEventListener('keydown', (e) => {
      if (modal.style.display === "block") {
        if (e.key === "ArrowLeft") {
          changeImage(-1);
        } else if (e.key === "ArrowRight") {
          changeImage(1);
        } else if (e.key === "Escape") {
          modal.style.display = "none";
        }
      }
    });

    async function renderSaved(){
      try {
        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        if (currentSearchTerm) {
          allEntries = await searchEntries(currentSearchTerm);
        } else {
          allEntries = await loadAllEntries();
        }
        
        const ul = by('saved'); 
        ul.innerHTML = '';
        
        if (!allEntries.length) { 
          ul.innerHTML = '<li class="meta">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</li>'; 
          by('storage-info').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: 0MB';
          by('pagination').style.display = 'none';
          return; 
        }
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ
        const storageUsage = calculateStorageUsage(allEntries);
        by('storage-info').textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ${storageUsage}MB`;
        
        // ‡πÅ‡∏™‡∏î‡∏á pagination
        by('pagination').style.display = 'flex';
        const totalPages = Math.ceil(allEntries.length / itemsPerPage);
        by('pageInfo').textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${currentPage} ‡∏à‡∏≤‡∏Å ${totalPages}`;
        
        // ‡∏õ‡∏∏‡πà‡∏° pagination
        by('prevPage').disabled = currentPage === 1;
        by('nextPage').disabled = currentPage === totalPages;
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, allEntries.length);
        const displayList = allEntries.slice().reverse().slice(startIndex, endIndex);
        
        displayList.forEach((item)=>{
          const li = document.createElement('li'); 
          li.className='saved-item card';
          const d = new Date(item.createdAt);
          li.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-weight:600">${escapeHtml(item.customer||'-')}</div>
                <div class="meta">${escapeHtml(item.tambon||'')} ${escapeHtml(item.amphoe||'')} ${escapeHtml(item.province||'')}</div>
              </div>
              <div style="text-align:right;font-size:12px;color:var(--muted)">${d.toLocaleString('th-TH')}</div>
            </div>
            <div style="height:8px"></div>
            <div class="meta">‡πÇ‡∏•‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô: ${item.lat||'-'}, ${item.lng||'-'} ‚Ä¢ ‡πÑ‡∏°‡∏•‡πå: ${item.mileage||'-'}</div>
          `;
          
          // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
          if (item.note) {
            const noteDiv = document.createElement('div');
            noteDiv.className = 'meta';
            noteDiv.style.marginTop = '6px';
            noteDiv.style.fontStyle = 'italic';
            noteDiv.textContent = `‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${escapeHtml(item.note)}`;
            li.appendChild(noteDiv);
          }
          
          // thumbnails
          if (item.photos && item.photos.length){
            const wrap = document.createElement('div'); 
            wrap.className='photos-preview';
            item.photos.slice(0,4).forEach((p, idx)=>{ 
              const i=document.createElement('img'); 
              i.src=p; 
              i.onclick = () => openModal(item.photos, idx);
              wrap.appendChild(i); 
            });
            li.appendChild(wrap);
          }
          
          // actions
          const actions = document.createElement('div'); 
          actions.style.marginTop='8px';
          actions.style.display = 'flex';
          actions.style.gap = '8px';
          actions.style.flexWrap = 'wrap';
          
          const btnView = document.createElement('button'); 
          btnView.className='btn small ghost'; 
          btnView.textContent='‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û';
          btnView.disabled = !item.photos || item.photos.length === 0;
          btnView.addEventListener('click', ()=> {
            if (item.photos && item.photos.length) {
              openModal(item.photos, 0);
            }
          });
          
          const btnExport = document.createElement('button'); 
          btnExport.className='btn small ghost'; 
          btnExport.textContent='Export';
          btnExport.addEventListener('click', ()=> downloadObject(item, `entry-${d.getTime()}.json`));
          
          const btnDelete = document.createElement('button'); 
          btnDelete.className='btn small ghost'; 
          btnDelete.textContent='‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
          btnDelete.addEventListener('click', async ()=>{
            if (!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
            try {
              await deleteEntry(item.id);
              renderSaved();
              showToast('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } catch (error) {
              showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
              console.error(error);
            }
          });
          
          actions.appendChild(btnView);
          actions.appendChild(btnExport); 
          actions.appendChild(btnDelete);
          li.appendChild(actions);
          ul.appendChild(li);
        });
      } catch (error) {
        console.error('Error rendering saved entries:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
      }
    }

    function escapeHtml(str){ 
      return String(str||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); 
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
    function validateForm() {
      let isValid = true;
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
      if (!by('customer').value.trim()) {
        by('customer').classList.add('error');
        by('customer-error').style.display = 'block';
        isValid = false;
      } else {
        by('customer').classList.remove('error');
        by('customer-error').style.display = 'none';
      }
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
      const lat = by('lat').value.trim();
      const lng = by('lng').value.trim();
      
      if (lat && isNaN(parseFloat(lat))) {
        showToast('‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        isValid = false;
      }
      
      if (lng && isNaN(parseFloat(lng))) {
        showToast('‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        isValid = false;
      }
      
      return isValid;
    }

    // Save entry
    by('save').addEventListener('click', async ()=>{
      if (!validateForm()) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
        return;
      }
      
      const entry = {
        customer: by('customer').value.trim(),
        tambon: by('tambon').value.trim(),
        amphoe: by('amphoe').value.trim(),
        province: by('province').value.trim(),
        lat: by('lat').value.trim(),
        lng: by('lng').value.trim(),
        mileage: by('mileage').value.trim(),
        note: by('note').value.trim(), // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
        photos: currentFilesBase64.slice(),
        createdAt: new Date().toISOString()
      };
      
      try {
        // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        by('save').innerHTML = '<span class="loading"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
        by('save').disabled = true;
        
        await saveEntry(entry);
        renderSaved();
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        clearForm();
      } catch (error) {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
        console.error(error);
      } finally {
        by('save').innerHTML = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
        by('save').disabled = false;
      }
    });

    by('resetForm').addEventListener('click', ()=>{ 
      if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
        clearForm(); 
        showToast('‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡πâ‡∏ß');
      }
    });

    function clearForm(){ 
      by('customer').value=''; 
      by('tambon').value=''; 
      by('amphoe').value=''; 
      by('province').value=''; 
      by('lat').value=''; 
      by('lng').value=''; 
      by('mileage').value=''; 
      by('note').value=''; // ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
      photosInput.value=''; 
      preview.innerHTML=''; 
      currentFilesBase64 = []; 
      
      // ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ error
      by('customer').classList.remove('error');
      by('customer-error').style.display = 'none';
      by('photos-error').style.display = 'none';
    }

    // Export & download helpers
    function downloadObject(obj, filename){ 
      const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'}); 
      const url=URL.createObjectURL(blob); 
      const a=document.createElement('a'); 
      a.href=url; 
      a.download=filename; 
      a.click(); 
      URL.revokeObjectURL(url); 
    }

    by('downloadAll').addEventListener('click', async ()=>{
      try {
        const arr = await loadAllEntries();
        if(!arr.length){ 
          showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î'); 
          return; 
        }
        downloadObject(arr, `site-logs-${new Date().toISOString().slice(0,10)}.json`);
        showToast('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      } catch (error) {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î');
        console.error(error);
      }
    });

    by('clearAll').addEventListener('click', async ()=>{
      if(!confirm('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ')) return; 
      try {
        await clearAllEntries();
        renderSaved();
        showToast('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß');
      } catch (error) {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
        console.error(error);
      }
    });

    // ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Pagination
    by('prevPage').addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        renderSaved();
      }
    });

    by('nextPage').addEventListener('click', () => {
      const totalPages = Math.ceil(allEntries.length / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        renderSaved();
      }
    });

    // ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    by('searchInput').addEventListener('input', (e) => {
      currentSearchTerm = e.target.value.trim();
      currentPage = 1; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
      
      // Debounce ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û
      clearTimeout(by('searchInput').timeout);
      by('searchInput').timeout = setTimeout(() => {
        renderSaved();
      }, 300);
    });

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô
    async function initApp() {
      try {
        db = await openDatabase();
        renderSaved();
      } catch (error) {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
        console.error(error);
      }
    }

    // initial render
    initApp();
  </script>
</body>
</html>
